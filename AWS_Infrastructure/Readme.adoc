= CDP Private Cloud Setup on AWS Infrastructure
:toc:

This document provides all the required information for Cloudera Partners to setup and install CDP Private Cloud on AWS Infrastructure(*EC2*). In addition to exploring the benefits of CDP Private Cloud with its rich Data Services, this setup can also be used for *ISV/IHV* certification, getting a Hands-on experience, or for any demos with potential customers. 


== Introduction

Cloudera Data Platform is a single platform that has two form factors CDP Public and CDP Private cloud. 

*CDP Public Cloud* is an integrated analytics and data management platform deployed on *cloud services*. It consists of a number of cloud services designed to address specific enterprise data cloud use cases.
This includes Data Hub powered by Cloudera Runtime, self-service experiences (Data Warehouse, Machine Learning, and Data Engineering) running on containers, the administrative layer (Management Console), and SDX services (Data Lake, Data Catalog, Replication Manager, and Workload Manager).

*CDP Private Cloud* is an integrated analytics and data management platform deployed in *private data centers*. It consists of CDP Private Cloud Base and CDP Private Cloud Data Services and offers broad data analytics and artificial intelligence functionality along with secure user access and data governance features. CDP Private Cloud (PvC) data services components run on containerized cluster and thus requires a container orchestration engine to manage all the workloads. CDP PvC offers installation with two orchestration engines. 

* Openshift Container Platform

* Embedded Container Service (Cloudera managed)

In this document, we focus on CDP Private Cloud setup with *ECS*. Let's have a look at the prerequisites before proceeding with the actual setup.

== Prerequisites

*Entitlements*

Your License key must have the PvC DS entitlement. A current key without the entitlement will block access to ECS bits. Please raise a ticket or reach out to the Cloudera POC to get the necessary entitlements.

*AWS*

Administrator access to AWS account. Please verify the resource limits in the region where you wish to deploy the cloud resources. 

== Infrastructure Setup

Below table summarizes the machines used for this POC. This is a minimum requirement, One can increase the number of machines to achieve High Availability and Fault Tolerance. If this cluster is not meant to perform any benchmarking or performance test, one can proceed ahead with this infrastructure.

=== Hardware

[frame=all, grid=all]
|===
|AWS Resource | Machine Size | Count | CDP Role | Storage

|EC2|m5.4xlarge|1|FreeIPA server|50 GB EBS Root volume

|EC2|m5.8xlarge|4|CDP Base Cluster|200 GB EBS Root volume

|EC2|m5.4xlarge|6|CDP ECS Cluster|150 GB Root Volume and  2 TB For ECS

|Elastic IP|NA|2|For Data Services & Cloudera Manager|NA
|===

=== Software


Below table summarizes the list of softwares/packages and their use for setting up CDP PvC cluster. 

[frame=all, grid=all]
|===
|Software | Version | Node | Role | Availability 

|Centos              |7.9         |All Machines           |Operating System      |AMI
|IPA Server          |Latest      |IPA Machine            |For Setting up KDC,DNS|Yum Package
|IPA Client          |Latest      |All Machines           |IPA/DNS Communication |Yum Package
|NFS Utility Package |Latest      |All Machine            |NFS Communication     |Yum package
|Cloudera Manager    |7.9.5       |CDP Base               |Management            |Cloudera Repo
|Cloudera Runtime    |7.1.8       |CDP Base and ECS Nodes |Runtime               |Cloudera Repo          
|Cloudera ECS        |1.5.0       |ECS Cluster Nodes      |Data Services         |Cloudera Repo
|OpenJDK             |1.8         |All Machines           |All CDP Hosts         |Cloudera Repo
|===


=== Summary
The below table contains the names assigned to the EC2 instances and to some other required components. Going forward in this document will refer to them by name.


*Note:* The hostnames mentioned here are just for convenience. You may choose to have the hostnames as per your requirements. 

[frame=all, grid=all]
|===
|Name                              |Description 

|pvcbasemaster                     |One Node CDP Private Cloud Base Master
|pvcbaseworker1 to pvcbaseworker3  |CDP Base Cluster Worker Nodes
|pvcipaserver                      |FreeIPA Server
|pvcecsmaster                      |ECS Master Node
|pvcecs1 to pvcecs6                |ECS Worker Nodes
|PVCSG                             |Common Security Group For All EC2.
|PVCBASE.COM                       |Dummy Domain For POC Purpose
|===

Once you have familiarized yourself with all the information mentioned above, you can start with the preliminary work for CDP Base setup. 

== Preliminary Work

Before getting into the actual installation of CDP Private Cloud Base & Data Services we need to prepare our machines and perform some steps to meet the prerequisites. 

=== Create Base AMI

In this step, an AMI will be created which will serve as the base AMI to provision all the EC2 instances that form the CDP PvC cluster. 

==== Step1

* Login to the AWS account and select the Region in which you want to deploy the cluster. 

* Start a t2.micro instance by using the AMI *CentOS 7 (x86_64) - with Updates HVM* and deploy it in the Public Subnet.

* Ensure that the OS version is Centos 7.9. 

* To verify the version, run the below command. It should return CentOS Linux release 7.9.2009 (Core). 
[,shell]
----
    cat /etc/centos-release
----
image::images/centos_ver.png[]

* If the output shows the version as Centos 7.6, then run the below command to update the OS to 7.9. Before updating, switch to root account. 
[,shell]
----
    sudo su - root
    yum update -y
----

* Generate a password protected private key by using the below command and create a password for this private key by entering it when prompted. 
[,shell]
----
    ssh-keygen -t rsa  -f /root/.ssh/id_rsa_new
----

image::/AWS_Infrastructure/images/ssh-keygen-pw.png[]

* Add the newly created key into authorized_keys by using below command. 
[,shell]
----
    cat /root/.ssh/id_rsa_new.pub >> /root/.ssh/authorized_keys
----

* Download the *id_rsa_new* key file to your local machine by using sftp. This will be required at the time of installation.


==== Step2

*  Reboot the instance and re-login and change the user to *root*. 

* *Disable SELinux:* Open the file */etc/selinux/config* for editing and update the value as shown below. 
[,shell]
----
    vi /etc/selinux/config
    SELINUX=disabled
----

image::AWS_Infrastructure/images/selinux.png[]


* *Set swappiness to 1:* Open the file */etc/sysctl.conf* for editing and add the below line.
[,shell]
----
    vi /etc/sysctl.conf
    vm.swappiness=1
----

* *Disable Transparent Huge Pages:* Open the file */etc/rc.d/rc.local* for editing and add the below lines.
[,shell]
----
    vi /etc/rc.d/rc.local
    echo never > /sys/kernel/mm/transparent_hugepage/enabled
    echo never > /sys/kernel/mm/transparent_hugepage/defrag
----

* *Disable IPV6:* Open the file */etc/rc.d/rc.local* for editing and add the below lines. 
[,shell]
----
    vi /etc/rc.d/rc.local
    sysctl -w net.ipv6.conf.all.disable_ipv6=1
    sysctl -w net.ipv6.conf.default.disable_ipv6=1
    sysctl -w net.ipv6.conf.lo.disable_ipv6=0
----

* *Add execute permission:* Run the below command to add execute permission to the file */etc/rc.d/rc.local*. 
[,shell]
----
    chmod +x /etc/rc.d/rc.local
----

* *Install packages:* Install the packages *_ipa-client_*, *_wget_*, *_ntpd_* through *yum* using the below command. 
[,shell]
----     
    yum install -y ipa-client wget ntpd
----

==== Step3

* *Create AMI:* Open AWS console and create AMI of this machine. Once the AMI is in *"Available"* state, terminate this instance. 

For all the EC2 instances to be created next, this AMI will be used. 

=== Install and Setup of IPA services

=== Setup Reverse DNS Zone

=== Add all the machines to DNS

=== Create Local mirror for ECS bits
== Private Cloud Base Setup
This section outlines the steps needed to set up a 4 nodes Private Cloud Base . Below are the prerequisites which base cluster should have before installing/configuring Data Services.

==== Download the Installer & Cloudera Repository file
* *Step 1:* Login the pvcbasemaster EC2 instance and switch to 'root' user. 
* *Step 2:* Navigate to */etc/yum.repos.d/* directory
[,shell]
----
   cd /etc/yum.repos.d/
----

* *Step 3:* Execute below command after replacing your *Cloudera Paywall Credentials*.
[,shell]
----
wget  https://<user_name>:<password>@archive.cloudera.com/p/cm7/7.9.5/redhat7/yum/cloudera-manager.repo
----
* *Step 4:* Navigate to */tmp/* directory
[,shell]
----
cd /tmp/
----

* *Step 5:* Download the *‘cloudera-manager-installer.bin’* file by using below command after replacing your *Cloudera Paywall Credentials*
[,shell]
----
wget https://<user_name>:<password>@archive.cloudera.com/p/cm7/7.9.5/cloudera-manager-installer.bin
----

* *Step 6:* Add the Executable permission to above downloaded file.
[,shell]
----
chmod u+x cloudera-manager-installer.bin
----
==== Install *Cloudera Manager* with *Embedded Database*.

* *Step 1:* Navigate to */tmp* directory.
[,shell]
----
cd /tmp/
----
* *Step 2:* Execute the bin file using below command to install.
[,shell]
----
./cloudera-manager-installer.bin
----

*1:* The *Cloudera Manager Read Me* page appears.

image::images/cdp-quick-start-deployment-cm-installer.png[]

Click *Next*

*2:* The *Cloudera Standard License* page appears.

image::images/cdp-quick-start-deployment-streams-cm-installer-license.png[]

Click *Next* to accept the license agreement

*3:* The installer starts and does the following:

   * *A:* Installs Oracle JDK:
   
image::images/cdp-quick-start-deployment-streams-install-jdk.png[]
         
   * *B:* Installs the Cloudera Manager Server. 
   
image::images/cdp-quick-start-deployment-streams-install-cm-server.png[]
         
   * *C:* Installs the embedded PostgreSQL packages and starts the database and Cloudera Manager Server. 
   
image::images/cdp-quick-start-deployment-streams-install-db.png[]

[,shell]
----
NOTE:
If the installation is interrupted, run the following command on the Cloudera Manager Server host before you retry the installation:
----
----
sudo /usr/share/cmf/uninstall-cloudera-manager.sh
----
----
The log files for the installer are stored in /var/log/cloudera-manager-installer/.
----
*4:* Exit the installer:

   * *A:* When the installation completes, the complete URL for the Cloudera Manager Admin Console displays, including the default port number: 7180.
    
           Make a note of this URL or take a screen capture as you will need it for the next task.
           
image::images/cdp-quick-start-deployment-streams-install-cm-url.png[]
   * *B:* Click *Ok*
   
          The success message appears
   
   * *C:* Click OK to exit the installer.
   
image::images/cdp-quick-start-deployment-streams-install-finish.png[]   
   
   
          
---
*Authors*

Puneet Joshi puneetjoshi@cloudera.com

Pannag Katti pkatti@cloudera.com

version-1.0, Feb 22, 2023
